sap.ui.define(["sap/ui/core/mvc/Controller","Project/Project/model/productsQuantityFormatter","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/Dialog","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/m/MessageBox","sap/f/library","sap/ui/core/Fragment"],function(t,e,o,r,a,i,s,d,n,c,u,l){"use strict";return t.extend("Project.Project.controller.Products",{formatter:e,onInit:function(){this.oTable=this.getView().byId("productsTable");this.oProductsModel=new o;this.oProductsModel.loadData("http://localhost:8080/GiftShop/api/products","",false);this.products=this.oProductsModel.getData();this.oTable.setModel(this.oProductsModel);this.oCategoryModel=new o;this.oCategoryModel.loadData("http://localhost:8080/GiftShop/api/categories","",false);this.categories=JSON.parse(this.oCategoryModel.getJSON());this.loRouter=sap.ui.core.UIComponent.getRouterFor(this)},onSearch:function(t){var e=[];var o=t.getSource().getValue();if(o&&o.length>0){e=new r({filters:[new r("name",a.Contains,o)]})}this.oTable.getBinding("content").filter(e,"Application")},onDataExportButtonPressed:sap.m.Table.prototype.exportData||function(t){var e=this.getView().getModel("i18n").getResourceBundle();var o=new d({exportType:new n({separatorChar:";"}),models:this.oTable.getModel(),rows:{path:"/"},columns:[{name:e.getText("ProductID"),template:{content:"{id}"}},{name:e.getText("ProductName"),template:{content:"{name}"}},{name:e.getText("Description"),template:{content:"{description}"}},{name:e.getText("Category"),template:{content:"{category/name}"}},{name:e.getText("NetPrice"),template:{content:"{netPrice}"}},{name:e.getText("GrossPrice"),template:{content:"{grossPrice}"}},{name:e.getText("Quantity"),template:{content:"{quantity}"}},{name:e.getText("StockID"),template:{content:"{stockId}"}}]});o.saveFile().catch(function(t){c.error(e.getText("ProductDownloadErrorMessage")+t)}).then(function(){o.destroy()})},onOpenViewSettings:function(t){var e="filter";if(t.getSource()instanceof sap.m.Button){var o=t.getSource().getId();if(o.match("sort")){e="sort"}}if(!this.byId("idProductsSettings")){l.load({id:this.getView().getId(),name:"Project.Project.view.Fragments.ProductsSettings",controller:this}).then(function(t){t.setModel(this.oCategoryModel,"category");this.getView().addDependent(t);t.open(e)}.bind(this))}else{this.byId("idProductsSettings").open(e)}},handleConfirm:function(t){var e=t.getParameters(),o=this.oTable.getBinding("content"),a,s,d=[],n=[];a=e.sortItem.getKey();s=e.sortDescending;d.push(new i(a,s));o.sort(d);e.filterItems.forEach(function(t){var e=t.getKey();var o=new r("category/name","EQ",e);n.push(o)});o.filter(n)},onProductPress:function(t){var e=t.getSource().getBindingContext().getPath(),o=e.split("/").slice(-1).pop();var r=JSON.parse(this.oProductsModel.getJSON())[o].id;this.loRouter.navTo("Product",{layout:u.LayoutType.MidColumnFullScreen,product:r})},onAddButtonPress:function(){this.addProductDialog=sap.ui.xmlfragment("Project.Project.view.Fragments.AddProduct",this);this.addProductDialog.setModel(this.oCategoryModel,"category");this.getView().addDependent(this.addProductDialog);this.addProductDialog.open()},onAddProductButtonPress:function(){this.create()},onCloseProductButtonPress:function(){this.addProductDialog.close();this.addProductDialog.destroy()},checkProductData:function(t){var e=this.getView().getModel("i18n").getResourceBundle();if(t.name===""||t.description===""||Number.isNaN(t.netPrice)||Number.isNaN(t.quantity)||t.stockId===""||t.category===""){c.error(e.getText("ProductAddErrorMessage_Empty"),{id:"idProductAddErrorMessageBox"});return false}if(Number(t.netPrice)<1||Number(t.netPrice)>1e5){c.error(e.getText("ProductAddErrorMessage_NetPrice"),{id:"idProductAddErrorMessageBox"});return false}if(Number(t.quantity)<0||Number(t.quantity)>1e5||!Number.isInteger(t.quantity)){c.error(e.getText("ProductAddErrorMessage_Quantity"),{id:"idProductAddErrorMessageBox"});return false}if(t.stockId.length!==7){c.error(e.getText("ProductAddErrorMessage_StockID"),{id:"idProductAddErrorMessageBox"});return false}return true},create:function(){var t=this.getView().getModel("i18n").getResourceBundle();var e=sap.ui.getCore();for(var o=0;o<this.categories.length;o++){if(parseInt(this.categories[o].id,10)===parseInt(e.byId("addProductCategorySelect").getSelectedKey(),10)){var r=this.categories[o]}}var a={name:e.byId("addProductName").getValue(),description:e.byId("addProductDescription").getValue(),netPrice:e.byId("addProductNetPrice").getValue(),quantity:parseInt(e.byId("addProductQuantity").getValue(),10),stockId:e.byId("addProductStockId").getValue(),category:{id:r.id,name:r.name,taxRate:r.taxRate}};var i=this.checkProductData(a);if(i){jQuery.ajax({type:"POST",contentType:"application/json",url:"http://localhost:8080/GiftShop/api/products",dataType:"json",data:JSON.stringify(a)});this.addProductDialog.destroy();c.success(t.getText("ProductAddSuccess"),{id:"idProductAddSuccessMessageBox",onClose:function(t){window.location.reload()}})}}})});