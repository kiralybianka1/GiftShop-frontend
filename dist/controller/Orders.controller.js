sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Sorter","sap/ui/core/Fragment"],function(e,t,i,r,s,o,a,d){"use strict";return e.extend("Project.Project.controller.Orders",{onInit:function(){this.oOrdersModel=new t;this.oOrdersModel.loadData("http://localhost:8080/GiftShop/api/orders","",false);this.orders=this.oOrdersModel.getData();this.oProductsModel=new t;this.oProductsModel.loadData("http://localhost:8080/GiftShop/api/products","",false);this.products=this.oProductsModel.getData();this.oCustomersModel=new t;this.oCustomersModel.loadData("http://localhost:8080/GiftShop/api/customers","",false);this.customers=this.oCustomersModel.getData();this.customerSelect=this.getView().byId("customerSelect");this.customerSelect.setModel(this.oCustomersModel);this.productSelect=this.getView().byId("productSelect");this.productSelect.setModel(this.oProductsModel);this.oTable=this.getView().byId("ordersTable");this.oTable.setModel(this.oOrdersModel);this.getView().byId("ordersDate").setDateValue(new Date);var e=this.getView().byId("ordersTable").getItems();for(var i=0;i<e.length;i++){var r=e[i].getBindingContext();var s=r.getProperty(null,r);var o=s.fulfillDate;if(o===null){var a=e[i].getCells();a[4].destroy();var d=this;e[i].addCell(new sap.m.DatePicker({displayFormat:"short",change:function(e){d.confirmFulfillDate(s,e.getSource().getValue())}}))}}},handleIconTabBarSelect:function(e){if(e.getParameter("key")==="info"){this.getView().byId("footer").setVisible(true)}else{this.getView().byId("footer").setVisible(false)}},confirmFulfillDate:function(e,t){var i=this.getView().getModel("i18n").getResourceBundle();var r=this;s.confirm(i.getText("ConfirmFulfillModify"),{actions:[s.Action.YES,s.Action.NO],onClose:function(i){if(i===s.Action.YES){r.modify(e,t)}}})},onDeleteButtonPress:function(e){var t=this.getView().getModel("i18n").getResourceBundle();var i=this.oTable.getSelectedItems();if(i.length===0){s.error(t.getText("OrderDeleteErrorMessage"))}else{var r=this.checkOrderDelete(i);if(r){var o=this;s.confirm(t.getText("ConfirmDelete"),{actions:[s.Action.YES,s.Action.NO],onClose:function(e){if(e===s.Action.YES){o.deleteManagement(i)}}})}else{s.error(t.getText("OrderDeleteErrorMessage"),{id:"idOrderDeleteErrorMessageBox"})}}},onSearch:function(e){var t=[];var s=e.getSource().getValue();if(s&&s.length>0){t=new i({filters:[new i("customer/lastName",r.Contains,s),new i("customer/firstName",r.Contains,s)],and:false})}this.oTable.getBinding("items").filter(t,"Application")},onSettingsButtonPressed:function(){if(!this.settingsDialog){this.settingsDialog=sap.ui.xmlfragment("Project.Project.view.Fragments.OrdersSettings",this);this.settingsDialog.setModel(this.oOrdersModel);this.getView().addDependent(this.settingsDialog)}this.settingsDialog.open()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().getId();if(i.match("sort")){t="sort"}}if(!this.byId("idOrdersSettings")){d.load({id:this.getView().getId(),name:"Project.Project.view.Fragments.OrdersSettings",controller:this}).then(function(e){e.setModel(this.getView().getModel());this.getView().addDependent(e);e.open(t)}.bind(this))}else{this.byId("idOrdersSettings").open(t)}},handleConfirm:function(e){var t=e.getParameters(),r=this.oTable.getBinding("items"),s,o,d=[],n=[];s=t.sortItem.getKey();o=t.sortDescending;d.push(new a(s,o));r.sort(d);t.filterItems.forEach(function(e){var t=e.getKey();if(t==="fulfilled"){n.push(new i("fulfillDate","NE",null))}else{n.push(new i("fulfillDate","EQ",null))}});r.filter(n)},onCustomerPress:function(e){var i=e.getSource().getParent().getCells()[0].getTitle();for(var r=0;r<this.orders.length;r++){if(parseInt(this.orders[r].id,10)===parseInt(i,10)){this.order=this.orders[r]}}var s=new t;s.setData(this.order);if(this.orderQuickView){this.orderQuickView.destroy()}this.orderQuickView=sap.ui.xmlfragment("Project.Project.view.Fragments.CustomerQuickView",this);this.orderQuickView.setModel(s);this.getView().addDependent(this.orderQuickView);var o=e.getSource();jQuery.sap.delayedCall(0,this,function(){this.orderQuickView.openBy(o)})},onProductsPress:function(e){var i=this.getView().getModel("i18n").getResourceBundle();var r=e.getSource().getBindingContext();var s=r.getProperty(null,r);var o=new t;o.setData(s);var a=i.getText("CustomerOrderProducts");var d={path:"/orderProductList/",template:new sap.m.StandardListItem({title:"{product/name}",info:"{quantity}"+" "+i.getText("QuantityType")})};this.resizableDialog=new sap.m.Dialog({title:a,contentWidth:"550px",contentHeight:"300px",resizable:true,content:new sap.m.List({items:d}),beginButton:new sap.m.Button({text:i.getText("Close"),press:function(){this.resizableDialog.close();this.resizableDialog.destroy()}.bind(this)})});this.resizableDialog.setModel(o);this.getView().addDependent(this.resizableDialog);this.resizableDialog.open()},customerValidation:function(){if(this.getView().byId("customerSelect").getSelectedItem()!==null){this.getView().byId("orderWizard").validateStep(this.getView().byId("customerWizard"))}else{this.getView().byId("orderWizard").invalidateStep(this.getView().byId("customerWizard"))}},onProductAddButtonPress:function(){var e=this.getView().getModel("i18n").getResourceBundle();if(this.getView().byId("productSelect").getSelectedItem()!==null){var t=this.getView().byId("productSelect").getSelectedItem().getKey();var i=this.getView().byId("productSelect").getSelectedItem().getText();var r=this.getView().byId("productQuantity").getValue();var o=this.getView().byId("productsList").getItems();var a=false;for(var d=0;d<o.length;d++){if(o[d].getLabel()===i+" (ID: "+t+")"){var n=o[d].getContent()[0].getValue();var l=n+r;if(l<=o[d].getContent()[0].getMax()){o[d].getContent()[0].setValue(l)}else{s.error(e.getText("OrderAddErrorMessage_MaxProduct"));o[d].getContent()[0].setValue(o[d].getContent()[0].getMax())}a=true}}if(!a){var c=0;for(d=0;d<this.products.length;d++){if(parseInt(this.products[d].id,10)===parseInt(t,10)){c=this.products[d].quantity}}this.getView().byId("productsList").addItem(new sap.m.InputListItem({label:i+" (ID: "+t+")",content:[new sap.m.StepInput({value:r,width:"30%",min:1,max:parseInt(c,10)}),new sap.m.ObjectIdentifier({title:t,visible:false})]}))}this.getView().byId("productQuantity").setValue(1)}else{s.error(e.getText("OrderAddErrorMessage_Product"))}this.productsValidation()},handleProductDelete:function(e){this.getView().byId("productsList").removeItem(e.getParameter("listItem"));this.productsValidation()},productsValidation:function(){var e=this.getView().byId("productsList").getItems();if(e.length>0){this.getView().byId("orderWizard").validateStep(this.getView().byId("productWizard"))}else{this.getView().byId("orderWizard").invalidateStep(this.getView().byId("productWizard"))}},orderCompletedHandler:function(e){var t=this.getView().getModel("i18n").getResourceBundle();var i=this.getView().byId("customerSelect").getSelectedItem().getText();var r=this.getView().byId("productsList").getItems();var s="";for(var o=0;o<r.length;o++){s+=r[o].getContent()[0].getValue()+t.getText("QuantityType")+" "+r[o].getLabel()+", "}var a=this.getView().byId("ordersDate").getValue();var d=this.getView().byId("ordersFulfillDate").getValue();var n=this.getView().byId("bill").getSelectedKey();var l=t.getText(n);this.model=new sap.ui.model.json.JSONModel;this.model.setProperty("/customer",i);this.model.setProperty("/products",s);this.model.setProperty("/ordersDate",a);this.model.setProperty("/ordersFulfillDate",d);this.model.setProperty("/bill",l);if(!this.reviewPage){this.reviewPage=sap.ui.xmlfragment("Project.Project.view.Fragments.ReviewPage",this);this.reviewPage.setModel(this.model);this.getView().addDependent(this.reviewPage)}this.reviewPage.open()},onSendOrderButtonPress:function(){this.create();this.getView().byId("customerSelect").setValue();this.clearContent(this.getView().byId("addProductForm").getContent());this.clearContent(this.getView().byId("addOrderForm").getContent());this.getView().byId("productsList").removeAllItems();this.getView().byId("ordersDate").setDateValue(new Date);this.getView().byId("bill").setSelectedKey("Yes");this.getView().byId("orderWizard").invalidateStep(this.getView().byId("customerWizard"));this.getView().byId("orderWizard").discardProgress(this.byId("customerWizard"));this.reviewPage.close()},onCancelOrderButtonPress:function(){this.reviewPage.close()},clearContent:function(e){for(var t=0;t<e.length;t++){if(e[t].setValue){e[t].setValue("")}if(e[t].getContent){this.clearContent(e[t].getContent())}}},checkOrderDelete:function(e){for(var t=0;t<e.length;t++){var i=e[t].getCells()[0].getTitle();for(var r=0;r<this.orders.length;r++){if(parseInt(this.orders[r].id,10)===parseInt(i,10)){if(this.orders[r].fulfillDate===null){return true}}}}return false},deleteManagement:function(e){var t=this.getView().getModel("i18n").getResourceBundle();for(var i=0;i<e.length;i++){var r=e[i].getCells()[0].getTitle();var o={id:r};jQuery.ajax({type:"DELETE",contentType:"application/json",url:"http://localhost:8080/GiftShop/api/orders/"+r,dataType:"json",data:JSON.stringify(o)})}s.success(t.getText("OrderDeleteSuccess"),{onClose:function(e){window.location.reload()}})},modify:function(e,t){var i=this.getView().getModel("i18n").getResourceBundle();e.fulfillDate=t.replace(/\. /g,"-").replace(/\./g,"");jQuery.ajax({type:"PUT",contentType:"application/json",url:"http://localhost:8080/GiftShop/api/orders",dataType:"json",data:JSON.stringify(e)});s.success(i.getText("OrderModifySuccess"),{onClose:function(e){window.location.reload()}})},create:function(){var e=this.getView().getModel("i18n").getResourceBundle();for(var t=0;t<this.customers.length;t++){if(parseInt(this.customers[t].id,10)===parseInt(this.getView().byId("customerSelect").getSelectedKey(),10)){var i=this.customers[t]}}var r=this.getView().byId("productsList").getItems();var o=[];for(var t=0;t<r.length;t++){for(var a=0;a<this.products.length;a++){if(parseInt(r[t].getContent()[1].getTitle(),10)===parseInt(this.products[a].id,10)){var d=this.products[a];var n={product:{id:d.id,name:d.name,description:d.description,category:{id:d.category.id,name:d.category.name,taxRate:d.category.taxRate},netPrice:d.netPrice,quantity:d.quantity,stockId:d.stockId},quantity:parseInt(r[t].getContent()[0].getValue(),10)};o.push(n)}}}var l=null;if(this.getView().byId("ordersFulfillDate").getValue()!==""){l=this.getView().byId("ordersFulfillDate").getValue().replace(/\. /g,"-").replace(/\./g,"")}var c={customer:{id:parseInt(i.id,10),firstName:i.firstName,lastName:i.lastName,address:{id:i.address.id,country:i.address.country,zipCode:i.address.zip,city:i.address.city,street:i.address.street,houseNumber:i.address.houseNumber,floor:i.address.floor,door:i.address.door,doorbell:i.address.doorbell},phone:i.phone,email:i.email,customerType:i.customerType,accountNumber:i.accountNumber},orderDate:this.getView().byId("ordersDate").getValue().replace(/\. /g,"-").replace(/\./g,""),fulfillDate:l,orderProductList:o};jQuery.ajax({type:"POST",contentType:"application/json",url:"http://localhost:8080/GiftShop/api/orders",dataType:"json",data:JSON.stringify(c)});s.success(e.getText("OrderAddSuccess"),{id:"idOrderAddSuccessMessageBox",onClose:function(e){window.location.reload()}})}})});